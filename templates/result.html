{% extends "base.html" %}
{% block content %}

{% set fit = result.get("fit", {}) %}
{% set score = fit.get("score") %}
{% set level = fit.get("level") %}
{% set reasons = fit.get("reasons", []) %}
{% set gaps = fit.get("gaps", []) %}

<div class="hero mb-4">
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
    <div>
      <h2 class="section-title mb-1">
        {{ job.get("title","Role") }} {% if job.get("company") %}<span class="subtle">@ {{ job.get("company") }}</span>{% endif %}
      </h2>
      <div class="subtle">
        {% if job.get("location") %}{{ job.get("location") }} • {% endif %}
        {% if job.get("source_url") %}<a class="subtle" href="{{ job.get('source_url') }}" target="_blank">Open job ↗</a>{% endif %}
      </div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-light" href="/applications">Back</a>
      <a class="btn btn-primary" href="/">New run</a>
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="subtle">Fit score</div>

        {% if score is not none %}
          {% set s = score|int %}
          <div class="display-4 fw-bold mb-1">{{ s }}/100</div>
          <div class="d-flex align-items-center gap-2">
            {% if s >= 75 %}
              <span class="badge badge-approved">{{ level or "Strong Fit" }}</span>
            {% elif s >= 45 %}
              <span class="badge badge-pending">{{ level or "Moderate Fit" }}</span>
            {% else %}
              <span class="badge badge-blocked">{{ level or "Weak Fit" }}</span>
            {% endif %}
            <span class="badge badge-soft">v1.1</span>
          </div>
        {% else %}
          <div class="display-6 fw-bold">—</div>
          <div class="subtle">No score generated.</div>
        {% endif %}

        <hr class="my-3" />
        <div class="subtle small">
          Tip: Use the copy buttons in each tab to quickly paste into docs.
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card h-100">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <h5 class="mb-2">Top reasons</h5>
            {% if reasons and reasons|length > 0 %}
              <ul class="mb-0">
                {% for r in reasons %}
                  <li class="mb-1">{{ r }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="subtle">No reasons found.</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <h5 class="mb-2">Gaps</h5>
            {% if gaps and gaps|length > 0 %}
              <ul class="mb-0">
                {% for g in gaps %}
                  <li class="mb-1">{{ g }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="subtle">No major gaps detected.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">

    <ul class="nav nav-pills gap-2 mb-3" id="resultTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-fit" type="button">Fit</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-job" type="button">Job parsed</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-resume" type="button">Resume bullets</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-cover" type="button">Cover letter</button>
      </li>
      {% if result.get("qna") %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-qna" type="button">Q&A</button>
      </li>
      {% endif %}
    </ul>

    <div class="tab-content">

      <!-- Fit -->
      <div class="tab-pane fade show active" id="tab-fit">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="subtle mb-2">Reasons</div>
            <div class="card">
              <div class="card-body">
                {% if reasons and reasons|length > 0 %}
                  <ul class="mb-0">
                    {% for r in reasons %}<li class="mb-1">{{ r }}</li>{% endfor %}
                  </ul>
                {% else %}
                  <div class="subtle">No reasons found.</div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="subtle mb-2">Gaps</div>
            <div class="card">
              <div class="card-body">
                {% if gaps and gaps|length > 0 %}
                  <ul class="mb-0">
                    {% for g in gaps %}<li class="mb-1">{{ g }}</li>{% endfor %}
                  </ul>
                {% else %}
                  <div class="subtle">No major gaps detected.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Job parsed -->
      <div class="tab-pane fade" id="tab-job">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="subtle">Structured notes extracted from the JD</div>
          <button class="btn btn-sm btn-outline-light" type="button" onclick="copyText('jobParsed')">Copy</button>
        </div>
        <div class="card">
          <div class="card-body">
            <pre id="jobParsed" class="mb-0" style="white-space: pre-wrap; color: inherit;">
{{ result.get("job_parsed_markdown") or "No parsed job markdown available." }}
            </pre>
          </div>
        </div>
      </div>

      <!-- Resume bullets -->
      <div class="tab-pane fade" id="tab-resume">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="subtle">Tailored bullets / resume snippets</div>
          <button class="btn btn-sm btn-outline-light" type="button" onclick="copyText('resumeBullets')">Copy</button>
        </div>
        <div class="card">
          <div class="card-body">
            <pre id="resumeBullets" class="mb-0" style="white-space: pre-wrap; color: inherit;">
{{ result.get("tailored_resume_md") or "No tailored resume output available." }}
            </pre>
          </div>
        </div>
      </div>

      <!-- Cover letter -->
      <div class="tab-pane fade" id="tab-cover">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="subtle">Cover letter draft</div>
          <button class="btn btn-sm btn-outline-light" type="button" onclick="copyText('coverLetter')">Copy</button>
        </div>
        <div class="card">
          <div class="card-body">
            <pre id="coverLetter" class="mb-0" style="white-space: pre-wrap; color: inherit;">
{{ result.get("cover_letter") or "No cover letter available." }}
            </pre>
          </div>
        </div>
      </div>

      <!-- QNA -->
      {% if result.get("qna") %}
      <div class="tab-pane fade" id="tab-qna">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="subtle">Answers to application questions</div>
          <button class="btn btn-sm btn-outline-light" type="button" onclick="copyText('qnaBlock')">Copy</button>
        </div>
        <div class="card">
          <div class="card-body">
            <pre id="qnaBlock" class="mb-0" style="white-space: pre-wrap; color: inherit;">
{{ result.get("qna") }}
            </pre>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>

<script>
  async function copyText(elementId) {
    try {
      const el = document.getElementById(elementId);
      const text = el ? el.innerText : "";
      await navigator.clipboard.writeText(text);
      alert("Copied to clipboard ✅");
    } catch (e) {
      alert("Copy failed. You can manually select and copy.");
    }
  }
</script>

{% endblock %}
